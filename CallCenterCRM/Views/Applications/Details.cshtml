@model CallCenterCRM.Models.Application
@using CallCenterCRM.Interfaces
@inject IUserService userService

@{
    string typeIdentityId = "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier";
    string userIdentityId = GetUserClaim(typeIdentityId);

    var isAuthenticated = User.Identity.IsAuthenticated;

    string GetUserClaim(string type)
    {
        return User.Identities.First().Claims.First(c => c.Type == type).Value;
    }
}

<h1>Details</h1>

<div>
    <h4>Application</h4>
    @if (userService.GetUserRole(userIdentityId) == Roles.CrmOperator.GetDisplayName())
    {
        <div class="toggle-selected">
            <a asp-controller="Applications" asp-action="ToggleSelected" asp-route-Id=@Model.Id>
                <i class="mdi mdi-@(Model.IsSelected ? "star" : "star-outline")"></i>
            </a>
        </div>
    }
    <hr />
    <dl class="row">
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.ExpireTime)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.ExpireTime)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.RelevantApplications)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.RelevantApplications)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Type)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Type)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Comment)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Comment)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Applicant)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Applicant.AdditionalNote)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Attachment)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Attachment.Extension)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Classification)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Classification.Direction)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Recipient)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Recipient.Title)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.CreatedDate)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.CreatedDate)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.UpdatedDate)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.UpdatedDate)
        </dd>
    </dl>
    
</div>

<div>
    @if (@Model.Status == ApplicationStatus.SendMod || @Model.Status == ApplicationStatus.RejectMod)
    {
        <a asp-action="Edit" asp-route-id="@Model?.Id" class="btn btn-primary btn-rounded btn-fw">Изменять</a>
    }
    else if (@Model.Status == ApplicationStatus.GotMod)
    {
        <a asp-action="SendOrg" asp-route-id="@Model?.Id" class="btn btn-warning btn-rounded btn-fw">Отправить организацию</a>
        <a asp-action="RejectMod" asp-route-id="@Model?.Id" class="btn btn-danger btn-rounded btn-fw">Отклонять</a>
    }
    else if (@Model.Status == ApplicationStatus.SendOrg)
    {
        <a asp-controller="Answers" asp-action="Create" asp-route-applicationId="@Model?.Id" class="btn btn-success btn-rounded btn-fw">Отправить организацию</a>
        <a asp-action="RejectOrg" asp-route-id="@Model?.Id" class="btn btn-danger btn-rounded btn-fw">Отклонять</a>
    }

    @if (userService.GetUserRole(userIdentityId) == Roles.CrmOperator.GetDisplayName()
    || userService.GetUserRole(userIdentityId) == Roles.CrmAdmin.GetDisplayName())
    {
        <a asp-action="Index" class="btn btn-secondary btn-rounded btn-fw">Назад</a>
    }
    else
    {
        <a class="btn btn-secondary btn-rounded btn-fw" asp-area="" asp-controller="Applications" asp-action="AppsList"
       asp-route-recipientId=@userService.GetUserId(userIdentityId)>
            Назад
        </a>
    }
</div>

